<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÅ Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">
</head>
<body class="race-body">
    <!-- Header -->
    <div id="header">
        <img id="flag-logo" src="Images/pixelflag-removebg-preview.png" alt="Flag Logo">
        <p id ='header-text'>Steam Racer</p>
        <div class="spacer"></div>
        <a href="index.html">
            <button>Home</button>
        </a>
        <a href="dashboard.html">
            <button>Dashboard</button>
        </a>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Side Panel -->
        <div class="side-panel">
            <div class="profile-section">
                <img id="profile-pic" alt="Logged in Users Steam Profile Picture" width="64">
                <p id="user-name"></p>
            </div>

            <div class="guide-section">
                <h4>Guide:</h4>
                <p class="guide-text">This will only work if your friends steam profile is public</p>
                
                <ol class="guide-steps">
                    <li>Select a friend to race.</li>
                    <li>Select a game you would like to race with your friend.</li>
                    <li>Hit the Start Race Button. Let the Race Begin!</li>
                </ol>
                
                <p class="guide-note">Whoever hits 100% achievements in the selected game wins!</p>
                
                <p class="guide-note">Achievement Progress won't be updated immediately due to Steam API caching.</p>
            </div>
        </div>

        <!-- Center Content -->
        <div class="center-content">
            <!-- Player Selection Area -->
            <div class="player-selection">
                <!-- Player 1 -->
                <div class="player-card">
                    <img id="profile-pic-player" alt="Player 1 Profile Picture" width="100">
                    <p id="user-name-player1"></p>
                </div>

                <!-- Player 2 -->
                <div class="player-card">
                    <img id="profile-pic-player2" alt="Player 2 Profile Picture" width="100" src="Images/questionmark.jpg">
                    <div class="custom-dropdown" id="player2-dropdown">
                        <div class="dropdown-selected">Select a Friend</div>
                        <div class="dropdown-items" id="dropdown-items" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Game Selection Container -->
            <div id="game-selection-container" style="display: none;">
                <h3>Pick a game to race:</h3>
                <select id="game-dropdown">
                    <option value="">Loading games...</option>
                </select>
                <button id="start-race-btn" style="display: none;">Start Race!</button>
            </div>
        </div>
    </div>

    <!-- Race View -->
    <div id="race-view" style="display: none;">
        <h2>Achievement Race!</h2>
        
        <div class="race-container">
            <div class="player-race-section">
                <div class="player-info">
                    <img id="race-user-avatar" width="64">
                    <span id="race-user-name"></span>
                </div>
                <div class="progress-bar-bg">
                    <div id="user-progress-bar" class="progress-bar-fill"></div>
                </div>
                <span id="user-achievement-count">0/0</span>
            </div>
         
            <div class="player-race-section">
                <div class="player-info">
                    <img id="race-friend-avatar" width="64">
                    <span id="race-friend-name"></span>
                </div>
                <div class="progress-bar-bg">
                    <div id="friend-progress-bar" class="progress-bar-fill"></div>
                </div>
                <span id="friend-achievement-count">0/0</span>
            </div>
        </div>

        <div id="winner-message" style="display: none; font-size: 24px; font-weight: bold; text-align: center;"></div>
    </div>
    
    <footer>
       <p>This site is not affiliated with or endorsed by Valve Corporation or Steam.</p>
    </footer>

<script>
    // Load user profile
    fetch('/api/me')
    .then(r => r.json())
    .then(user => {
        document.getElementById('profile-pic').src = user.avatar;
        document.getElementById('profile-pic-player').src = user.avatar;
        document.getElementById('user-name').textContent = user.username;
        document.getElementById('user-name-player1').textContent = user.username;
    });

    let selectedFriendId = null;
    let selectedFriendName = null;
    
    // Friend selection dropdown
    const player2Icon = document.getElementById('profile-pic-player2');
    const dropdown = document.getElementById('player2-dropdown');
    const selected = dropdown.querySelector('.dropdown-selected');
    const itemsContainer = document.getElementById('dropdown-items');

    selected.addEventListener('click', async () => {
        const isVisible = itemsContainer.style.display === 'block';
        itemsContainer.style.display = isVisible ? 'none' : 'block';
        
        if (!isVisible && itemsContainer.children.length === 0) {
            const response = await fetch('/api/friends');
            const data = await response.json();
            
            data.forEach(friend => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.innerHTML = `<img src="${friend.avatar}"> ${friend.personaname}`;
                div.onclick = async () => {
                    selectedFriendId = friend.steamid;
                    selectedFriendName = friend.personaname;
                    selected.textContent = friend.personaname;
                    itemsContainer.style.display = 'none';
                    player2Icon.src = friend.avatarfull;
                    
                    await loadCommonGames(friend.steamid);
                };
                itemsContainer.appendChild(div);
            });
        }
    });

    async function loadCommonGames(friendId) {
        document.getElementById('game-selection-container').style.display = 'block';

        const dropdown = document.getElementById('game-dropdown');
        dropdown.innerHTML = '<option value="">Loading...</option>'; 

        try {
            const response = await fetch(`/api/common-games?friendId=${friendId}`);
            const games = await response.json();

            dropdown.innerHTML = ''; 

            if (games.length === 0) {
                dropdown.innerHTML = '<option value="">No common games found</option>';
                return;
            }

            games.forEach(game => {
                const option = document.createElement('option');
                option.value = game.appid;
                option.textContent = game.name;
                dropdown.appendChild(option);
            });

            document.getElementById('start-race-btn').style.display = 'block';
            
        } catch (error) {
            console.error('Error: ', error);
            dropdown.innerHTML = '<option value="">Error loading games</option>';
        }
    }

    document.getElementById('start-race-btn').addEventListener('click', async () => {
        const gameDropdown = document.getElementById('game-dropdown');
        const selectedAppId = gameDropdown.value; 

        const response = await fetch(`/api/achievements?friendId=${selectedFriendId}&appId=${selectedAppId}`);
        const data = await response.json();

        document.querySelector('.main-container').style.display = 'none';
        document.getElementById('race-view').style.display = 'block';

        // User Race Display
        document.getElementById('race-user-avatar').src = document.getElementById('profile-pic').src;
        document.getElementById('race-user-name').textContent = document.getElementById('user-name').textContent;
        document.getElementById('user-progress-bar').style.width = data.user.percentage + '%';
        document.getElementById('user-achievement-count').textContent = data.user.unlocked + '/' + data.total;

        // Friend Race Display
        document.getElementById('race-friend-avatar').src = document.getElementById('profile-pic-player2').src;
        document.getElementById('race-friend-name').textContent = selectedFriendName;
        document.getElementById('friend-progress-bar').style.width = data.friend.percentage + '%';
        document.getElementById('friend-achievement-count').textContent = data.friend.unlocked + '/' + data.total;

        setPolling(selectedFriendId, selectedAppId, selectedFriendName);
    });

    function setPolling(friendId, appId, selectedFriendName) {
        const pollingInterval = setInterval(async () => {
            const response = await fetch(`/api/achievements?friendId=${friendId}&appId=${appId}`);
            const data = await response.json();

            document.getElementById('user-progress-bar').style.width = data.user.percentage + '%';
            document.getElementById('friend-progress-bar').style.width = data.friend.percentage + '%';

            document.getElementById('user-achievement-count').textContent = data.user.unlocked + '/' + data.total;
            document.getElementById('friend-achievement-count').textContent = data.friend.unlocked + '/' + data.total;

            if(data.friend.percentage >= 100 && data.user.percentage >= 100) {
                clearInterval(pollingInterval);
                document.getElementById('winner-message').textContent = `Tie!`;
                document.getElementById('winner-message').style.display = 'block';
            } else if(data.friend.percentage >= 100) {
                clearInterval(pollingInterval);
                document.getElementById('winner-message').textContent = `${selectedFriendName} has won! üéä`;
                document.getElementById('winner-message').style.display = 'block';
            } else if(data.user.percentage >= 100){
                clearInterval(pollingInterval);
                const userName = document.getElementById('race-user-name').textContent;
                document.getElementById('winner-message').textContent = `${userName} has won! üéä`;
                document.getElementById('winner-message').style.display = 'block';
            }
        }, 3000);
    }
</script>

</body>
</html>